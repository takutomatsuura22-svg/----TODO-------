# 「アクセスをブロック: このアプリのリクエストは無効です」エラーの解決方法

## 🔍 エラーの原因

このエラーは、Google Cloud ConsoleのOAuth設定に問題がある場合に発生します。主な原因は以下の通りです：

1. **OAuth同意画面が正しく設定されていない**
2. **テストユーザーが追加されていない**（外部ユーザータイプの場合）
3. **承認済みのリダイレクトURIが正しく設定されていない**
4. **アプリがまだ検証されていない**（外部ユーザータイプの場合）

## ✅ 解決手順

### ステップ1: OAuth同意画面の設定を確認

1. **Google Cloud Consoleにアクセス**
   - https://console.cloud.google.com にログイン
   - プロジェクトを選択

2. **OAuth同意画面を開く**
   - 左メニュー → **APIとサービス** → **OAuth同意画面**

3. **設定を確認**
   - **公開ステータス**が「**テスト中**」または「**公開**」になっているか確認
   - 「**テスト中**」の場合は、テストユーザーを追加する必要があります（ステップ2を参照）

### ステップ2: テストユーザーを追加（外部ユーザータイプの場合）

**重要**: 外部ユーザータイプを選択した場合、アプリが検証されるまで、テストユーザーとして追加されたGoogleアカウントのみがログインできます。

1. **OAuth同意画面でテストユーザーを追加**
   - Google Cloud Console → **APIとサービス** → **OAuth同意画面**
   - **「テストユーザー」** セクションを確認
   - **「+ ADD USERS」** または **「ユーザーを追加」** をクリック

2. **自分のGoogleアカウントを追加**
   - ログインに使用するGoogleアカウントのメールアドレスを入力
   - **「追加」** をクリック
   - **重要**: 複数のGoogleアカウントでテストする場合は、すべて追加してください

3. **保存**
   - 設定が保存されたことを確認

### ステップ3: 承認済みのリダイレクトURIを確認

1. **認証情報ページを開く**
   - Google Cloud Console → **APIとサービス** → **認証情報**

2. **OAuth 2.0 クライアント IDを確認**
   - 作成したOAuth 2.0 クライアント IDをクリック

3. **承認済みのリダイレクトURIを確認**
   - **承認済みのリダイレクト URI** セクションを確認
   - 以下が含まれているか確認：
     ```
     https://[あなたのSupabaseプロジェクトID].supabase.co/auth/v1/callback
     ```
   - **例**: プロジェクトIDが `wkkffimnocaiaubhyvlb` の場合
     ```
     https://wkkffimnocaiaubhyvlb.supabase.co/auth/v1/callback
     ```

4. **URIが含まれていない場合**
   - **「URIを追加」** をクリック
   - 上記のURIを入力
   - **「保存」** をクリック

### ステップ4: アプリの公開ステータスを確認

1. **OAuth同意画面を開く**
   - Google Cloud Console → **APIとサービス** → **OAuth同意画面**

2. **公開ステータスを確認**
   - **公開ステータス**が「**テスト中**」の場合：
     - テストユーザーとして追加されたアカウントのみがログインできます
     - すべてのユーザーがログインできるようにするには、アプリを公開する必要があります
   - **公開ステータス**が「**公開**」の場合：
     - すべてのユーザーがログインできます

3. **アプリを公開する（オプション）**
   - 「**公開**」ボタンをクリック
   - 確認ダイアログで「**公開**」をクリック
   - **注意**: アプリを公開すると、すべてのユーザーがログインできるようになります

## 🔄 よくある問題と解決方法

### 問題1: テストユーザーを追加したのにエラーが発生する

**原因:**
- テストユーザーとして追加したメールアドレスと、ログインに使用しているGoogleアカウントのメールアドレスが一致していない

**解決方法:**
1. OAuth同意画面でテストユーザーを確認
2. ログインに使用しているGoogleアカウントのメールアドレスが追加されているか確認
3. 含まれていない場合は追加

### 問題2: 承認済みのリダイレクトURIが正しく設定されているのにエラーが発生する

**原因:**
- URIに余分なスペースや文字が含まれている
- URIの形式が正しくない

**解決方法:**
1. 承認済みのリダイレクトURIを確認
2. 以下の形式であることを確認：
   ```
   https://[プロジェクトID].supabase.co/auth/v1/callback
   ```
3. 余分なスペースや文字がないか確認
4. 必要に応じて削除して再追加

### 問題3: アプリを公開してもエラーが発生する

**原因:**
- OAuth同意画面の設定が不完全
- 必要な情報が入力されていない

**解決方法:**
1. OAuth同意画面の各ステップを確認
2. アプリ名、ユーザーサポートメール、デベロッパーの連絡先情報が入力されているか確認
3. すべてのステップを完了しているか確認

## 📋 チェックリスト

以下の項目を確認してください：

- [ ] OAuth同意画面が設定されている
- [ ] アプリ名が入力されている
- [ ] ユーザーサポートメールが入力されている
- [ ] デベロッパーの連絡先情報が入力されている
- [ ] テストユーザーが追加されている（外部ユーザータイプの場合）
- [ ] 承認済みのリダイレクトURIにSupabaseのコールバックURLが設定されている
- [ ] リダイレクトURIの形式が正しい（`https://[プロジェクトID].supabase.co/auth/v1/callback`）
- [ ] ログインに使用するGoogleアカウントがテストユーザーに追加されている

## 🔗 参考リンク

- [Google Cloud Console - OAuth同意画面](https://console.cloud.google.com/apis/credentials/consent)
- [Google Cloud Console - 認証情報](https://console.cloud.google.com/apis/credentials)
- [Google OAuth設定ガイド](./GOOGLE_OAUTH_SETUP.md)
- [Google Cloud認証情報の取得と設定ガイド](./GOOGLE_CLOUD_CREDENTIALS.md)
